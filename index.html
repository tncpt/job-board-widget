<!DOCTYPE html>
<html lang="en">
<head>

<!-- BEGIN Circle Widget Head -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
    :root {
        --primary-color: var(--brand, #007daf);
        --secondary-color: #e67300;
        --tertiary-color: #10a597;
        --accent-primary: #fdb813;
        --accent-secondary: #bd3f67;
        --background-color: var(--color-background-secondary, #fefcfa);
        --card-background: var(--color-background-primary, #f7f9fa);
        --text-color: var(--color-text-dark, #2b2b2b);
        --light-text-color: var(--color-text-light, #717680);
        --border-color: var(--color-border-primary, #e0e0e0);
        --shadow-color: rgba(0, 0, 0, 0.1);
        --font-family: var(--font-system-ui, Nunito, system-ui, sans-serif);
        --alert-red: #e51235;
    }

    html {
        font-size: 16px;
    }

    #jbw-root .jbw-input-error {
        border: 3px solid var(--alert-red) !important;
        outline: none;
    }

    #jbw-root,
    #jbw-root *,
    #jbw-root *::before,
    #jbw-root *::after {
        box-sizing: border-box;
    }

    #jbw-root {
        font-family: var(--font-family);
        font-size: 1rem;
        color: inherit;
        background-color: var(--background-color);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    #jbw-root h1 {
        font-family: var(--font-family);
        font-size: 2.5rem;
        color: var(--text-color);
        text-align: center;
        margin-bottom: 10px;
    }

    #jbw-root h2,
    #jbw-root h3,
    #jbw-root h4,
    #jbw-root p {
        font-family: var(--font-family);
        margin: 0;
    }

    #jbw-root p.app-subtitle {
        text-align: center;
        color: var(--light-text-color);
        margin: 0 0 30px 0;
        font-size: 1.1rem;
    }

    #jbw-root p.app-subtitle a {
        color: var(--primary-color);
    }

    #jbw-root .app-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    #jbw-root .job-board-layout {
        display: flex;
        gap: 30px;
        align-items: flex-start;
        min-height: 100vh;
    }

    #jbw-root .filter-panel {
        flex: 0 0 280px;
        position: sticky;
        top: 20px;

        /*
        To get a 10px gap when -50px only gave you 2px:
        We need to reduce the height by another 8px.
        -50px (original) - 8px (to reach 10px gap) = -58px.
        We'll use -60px for a clean, safe 12px gap.
        */
        max-height: calc(100vh - 60px);

        overflow-y: auto;
        overflow-x: hidden;
        scrollbar-gutter: stable;

        /* Internal padding ensures that when you scroll to the bottom
        of the sidebar, the bottom border/shadow of the aside is
        clearly visible inside the scroll area. */
        padding-bottom: 40px;

        scroll-behavior: smooth;
    }

    #jbw-root .filter-panel-top {
        background-color: var(--card-background);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px var(--shadow-color);
        margin-bottom: 20px;
    }

    #jbw-root .filter-panel-bottom {
        background-color: var(--card-background);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px var(--shadow-color);
        margin-bottom: 0;
    }

    #jbw-root .filter-panel::-webkit-scrollbar {
        width: 6px;
    }
    #jbw-root .filter-panel::-webkit-scrollbar-thumb {
        background-color: var(--border-color);
        border-radius: 10px;
    }

    #jbw-root .filter-group {
        margin-bottom: 25px;
        position: relative;
    }

    #jbw-root .filter-group h3 {
        font-size: 1.1rem;
        margin: 0 0 8px 0;
        padding-bottom: 0;
        color: var(--text-color);
        line-height: 1.2;
    }

    #jbw-root .filter-group input[type="text"],
    #jbw-root .filter-group input[type="number"],
    #jbw-root .filter-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 1rem;
    }

    #jbw-root .filter-group select {
        background-color: white;
        cursor: pointer;
    }

    #jbw-root .filter-group select.placeholder {
        color: var(--light-text-color);
    }

    #jbw-root .filter-group select option {
        color: var(--text-color);
    }

    #jbw-root .filter-group input[type="number"] {
        padding-right: 5px;
    }

    #jbw-root .filter-group input[type="number"]::-webkit-inner-spin-button,
    #jbw-root .filter-group input[type="number"]::-webkit-outer-spin-button {
        opacity: 1;
        width: 50px;
        margin-left: 10px;
        cursor: pointer;
        position: relative;
        right: 0;
    }

    #jbw-root .filter-group input[type="number"]::-webkit-inner-spin-button {
        height: 38px;
    }

    #jbw-root .checkbox-group {
        padding-top: 8px;
        display: flex;
        flex-direction: column;
    }

    #jbw-root .checkbox-group label {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        cursor: pointer;
        font-weight: 500;
        line-height: 1;
        color: var(--text-color);
    }

    #jbw-root .checkbox-group input[type="checkbox"],
    #jbw-root .checkbox-group input[type="radio"] {
        appearance: none;
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border: 2px solid var(--border-color);
        background-color: var(--background-color);
        margin: 0 8px 0 0;
        cursor: pointer;
        position: relative;
        display: grid;
        place-content: center;
        transition: background-color 0.1s, border-color 0.1s;
        flex-shrink: 0;
    }

    #jbw-root .checkbox-group input[type="checkbox"] {
        border-radius: 4px;
    }

    #jbw-root .checkbox-group input[type="radio"] {
        border-radius: 50%;
    }

    #jbw-root .checkbox-group input[type="checkbox"]:checked,
    #jbw-root .checkbox-group input[type="radio"]:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    #jbw-root .checkbox-group input[type="checkbox"]::before,
    #jbw-root .checkbox-group input[type="radio"]::before {
        content: "";
        transform: scale(0);
        transition: 120ms transform ease-in-out;
        background-color: white;
    }

    #jbw-root .checkbox-group input[type="checkbox"]::before {
        width: 10px;
        height: 10px;
        clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
    }

    #jbw-root .checkbox-group input[type="radio"]::before {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    #jbw-root .checkbox-group input[type="checkbox"]:checked::before,
    #jbw-root .checkbox-group input[type="radio"]:checked::before {
        transform: scale(1);
    }

    .jbw-dropdown-trigger {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: white;
        text-align: left;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1rem;
        color: var(--text-color);
        font-family: var(--font-family);
    }

    .jbw-dropdown-trigger::after {
        content: '‚ñº';
        font-size: 0.875rem;
        color: var(--light-text-color);
    }

    .jbw-dropdown-menu {
        max-height: 250px;
        overflow-y: auto;
        display: none;
        position: relative;
        width: 100%;
        background: white;
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 4px 4px;
        z-index: 1;
        padding: 12px;
        box-shadow: inset 0 2px 4px var(--shadow-color);
    }

    .jbw-dropdown-trigger.placeholder {
        color: var(--light-text-color);
    }

    .jbw-dropdown-menu.active {
        display: block;
    }

    .jbw-dropdown-wrapper {
        position: relative;
        width: 100%;
    }

    .jbw-dropdown-wrapper.is-active .jbw-dropdown-trigger {
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
    }

    .jbw-tag-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
        position: relative;
        z-index: 1;
    }

    .jbw-tag {
        background: var(--primary-color);
        color: white;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 1.0rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .jbw-tag-remove {
        cursor: pointer;
        font-size: 1.1rem;
        line-height: 1;
        opacity: 0.7;
    }

    .jbw-tag-remove:hover {
        opacity: 1;
    }

    #jbw-root .clear-filters-btn {
        width: 100%;
        padding: 12px;
        background-color: var(--secondary-color);
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    #jbw-root .clear-filters-btn:hover {
        background-color: var(--secondary-color-hover, var(--secondary-color));
    }

    #jbw-root #jbw-apply-text-filters {
        background-color: var(--secondary-color);
        margin-top: 25px;
        font-weight: bold;
        font-size: 1.1rem;
    }

    #jbw-root .clear-filters-link {
        display: block;
        text-align: center;
        font-weight: bold;
        color: var(--primary-color);
        text-decoration: none;
        padding-top: 14px;
        cursor: pointer;
    }

    #jbw-root .clear-filters-link:hover {
        text-decoration: underline;
    }

    #jbw-filter-error {
        display: none;
        color: var(--alert-red);
        background: none;
        font-size: 0.98rem;
        margin: 20px 0 0 0;
        padding: 0;
        text-align: left;
    }

    #jbw-filter-error.visible {
        display: block;
    }

    #jbw-root .job-list {
        flex: 1;
    }

    #jbw-root .job-card {
        display: block;
        text-decoration: none;
        color: inherit;
        background-color: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px var(--shadow-color);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    #jbw-root .job-card-featured {
        background-color: color-mix(in srgb, var(--accent-primary) 5%, white 95%) !important;
    }
    #jbw-root .job-card-featured .job-card-company,
    #jbw-root .job-card-featured .job-card-details {
        color: #2b2b2b !important;
    }

    #jbw-root .job-card,
    #jbw-root .job-card:active,
    #jbw-root .job-card:hover,
    #jbw-root .job-card:link,
    #jbw-root .job-card:visited {
        color: inherit;
        text-decoration: none;
    }

    #jbw-root .job-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px var(--shadow-color);
    }

    #jbw-root .job-card-header {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        margin-bottom: 15px;
    }

    #jbw-root .job-card-header .logo-container {
        width: 50px;
        height: 50px;
        flex-shrink: 0;
        position: relative;
        border-radius: 50%;
        overflow: hidden;
        border: 1px solid var(--border-color);
        z-index: 0;
    }

    #jbw-root .job-card-header img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        background-color: white;
        display: block;
        position: relative;
        z-index: 2;
    }

    #jbw-root .logo-fallback {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        color: white;
        font-size: 1.2rem;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
        transition: filter 0.2s ease-in-out;
    }

    #jbw-root .job-card:hover .logo-fallback {
        filter: brightness(1.1);
    }

    #jbw-root .job-card-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    #jbw-root .job-card-company {
        font-size: 1rem;
        font-weight: 500;
        line-height: 1.5;
        color: var(--text-color);
    }

    #jbw-root .job-card-details {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        color: var(--text-color);
        opacity: 0.8;
        font-size: 1rem;
        font-weight: 500;
        line-height: 1.4;
    }

    #jbw-root .job-card-details span {
        display: inline-flex;
        align-items: center;
    }

    #jbw-root .job-card-details span:not(:last-child)::after {
        content: '‚Ä¢';
        margin: 0 0 0 8px;
        color: var(--text-color);
        opacity: 0.5;
    }

    #jbw-root .job-card-description {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--border-color);
        color: var(--text-color);
        font-size: 0.95rem;
    }

    #jbw-root .job-card-skills {
        margin-top: 15px;
    }

    #jbw-root .job-card-skills h4 {
        margin-bottom: 10px;
        font-size: 0.95rem;
        color: var(--text-color);
    }

    #jbw-root .job-card-skills-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    #jbw-root .skill-tag {
        background-color: var(--background-color);
        color: var(--primary-color);
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.9rem;
        font-weight: 500;
    }

    #jbw-root .no-jobs-found {
        text-align: center;
        padding: 40px;
        font-size: 1.2rem;
        color: var(--light-text-color);
    }

    @media (max-width: 768px) {
        #jbw-root h1 {
            font-size: 2rem;
        }

        #jbw-root .job-board-layout {
            flex-direction: column;
            align-items: stretch;
            min-height: auto;
        }

        #jbw-root .filter-panel {
            flex: none;
            position: relative;
            top: 0;
            width: 100%;
            max-height: none !important;
            overflow: visible;
            padding-bottom: 20px;
        }

        #jbw-root .job-list {
            width: 100%;
        }

        #jbw-root .job-card-header > div { min-width: 0; }
        #jbw-root .job-card-title,
        #jbw-root .job-card-company,
        #jbw-root .job-card-details,
        #jbw-root .job-card-description { overflow-wrap: anywhere; }

        #jbw-root .job-card-title,
        #jbw-root .job-card-description {
            display: -webkit-box;
            line-clamp: 2;
            overflow: hidden;
            -webkit-box-orient: vertical;
        }

        #jbw-root .job-card-title {
            line-clamp: 2;
            -webkit-line-clamp: 2;
        }

        #jbw-root .job-card-description {
            line-clamp: 4;
            -webkit-line-clamp: 4;
        }
    }
</style>
<!-- END Circle Widget Head -->

</head>
<body>

<!-- BEGIN Circle Widget Body -->
<div id="jbw-root">
    <div class="app-container">
        <h1>Non-Clinical Jobs</h1>
        <p class="app-subtitle">
            üî• Never miss a posting from your dream employers! Simply
            <a href="https://nonclinical.notion.site/17d2a7006bfc80d99059cad5bac1ad04" target="_blank"><b>request companies here.</b></a>
        </p>

        <div class="job-board-layout">
            <aside class="filter-panel" id="filter-panel">
                <div class="filter-panel-top">
                    <div class="filter-group">
                        <h3>Search by Keyword</h3>
                        <input type="text" id="jbw-search-input" placeholder="e.g., Manager, Specialist">
                    </div>

                    <div class="filter-group">
                        <h3>City</h3>
                        <input type="text" id="jbw-city-input" placeholder="e.g., New York" maxlength="40">
                    </div>

                    <div class="filter-group">
                        <h3>State</h3>
                        <select id="jbw-state-select" class="placeholder"></select>
                    </div>

                    <div class="filter-group">
                        <h3>Zip Code</h3>
                        <input type="text" id="jbw-postal-input" placeholder="e.g., 90013" maxlength="5"
                            pattern="[0-9]*" inputmode="numeric">
                    </div>

                    <div class="filter-group" style="margin-bottom: 0;">
                        <h3>Distance (miles)</h3>
                        <input type="number" id="jbw-miles-input" value="30" min="1" max="12500" step="1">
                    </div>

                    <div id="jbw-filter-error"></div>
                    <button id="jbw-apply-text-filters" class="clear-filters-btn" style="margin-bottom: 0;">Search Jobs</button>
                </div>

                <div class="filter-panel-bottom">
                    <div class="filter-group">
                        <h3>Experience Level</h3>
                        <div class="checkbox-group" id="jbw-level-filter">
                            <label><input type="radio" name="experience_level" value="entry"> Starter</label>
                            <label><input type="radio" name="experience_level" value="experienced">
                                Experienced</label>
                        </div>
                    </div>

                    <div class="filter-group">
                        <h3>Employment Type</h3>
                        <div class="jbw-dropdown-wrapper" id="jt-wrapper">
                            <button type="button" class="jbw-dropdown-trigger placeholder" id="jt-trigger">Select...</button>
                            <div class="jbw-dropdown-menu" id="jt-menu">
                                <div class="checkbox-group" id="jbw-type-filter">
                                    <label><input type="checkbox" value="Contract"> Contract</label>
                                    <label><input type="checkbox" value="Full-time"> Full-time</label>
                                    <label><input type="checkbox" value="Part-time"> Part-time</label>
                                    <label><input type="checkbox" value="Per-diem"> Per-diem</label>
                                    <label><input type="checkbox" value="PRN"> PRN</label>
                                </div>
                            </div>
                        </div>
                        <div class="jbw-tag-container" id="jt-tags-container"></div>
                    </div>

                    <div class="filter-group" style="margin-bottom: 4px;">
                        <h3>Work Setting</h3>
                        <div class="jbw-dropdown-wrapper" id="wp-wrapper">
                            <button type="button" class="jbw-dropdown-trigger placeholder" id="wp-trigger">Select...</button>
                            <div class="jbw-dropdown-menu" id="wp-menu">
                                <div class="checkbox-group" id="jbw-workplace-filter">
                                    <label><input type="checkbox" value="Remote"> Remote</label>
                                    <label><input type="checkbox" value="On-site"> On-site</label>
                                    <label><input type="checkbox" value="Hybrid"> Hybrid</label>
                                    <label><input type="checkbox" value="Field"> Field</label>
                                </div>
                            </div>
                        </div>
                        <div class="jbw-tag-container" id="wp-tags-container"></div>
                    </div>

                    <a href="#" id="jbw-clear-filters-link" class="clear-filters-link">Clear Search & Filters</a>
                </div>
            </aside>

            <main class="job-list" id="jbw-job-list">
            </main>
        </div>
    </div>
</div>

<script>
    (function () {
        const SUPABASE_URL = 'https://woemwmydfdajegiemljg.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable__NX0fZeauvLKYNM6vKGaLA_m9lp6E8Q';

        let currentJobs = [];
        let fetchController = null;
        const ROOT = document.getElementById('jbw-root');

        // --- 1. DEFINE FUNCTIONAL REQUIREMENTS ---
        const capitalize = (s) => String(s || '').charAt(0).toUpperCase() + String(s || '').slice(1);
        const formatLevel = (level) => {
            const levelLower = String(level || '').toLowerCase();
            if (levelLower === 'entry') return 'Starter';
            if (levelLower === 'experienced') return 'Experienced';
            return capitalize(level);
        };
        const escapeHtml = (str) => String(str === undefined || str === null ? '' : str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\"/g, '&quot;')
            .replace(/'/g, '&#39;');
        const getCheckedValues = (container) =>
            Array.from(container.querySelectorAll('input:checked')).map(cb => cb.value);

        // --- SUPABASE FETCH FUNCTION ---
        async function fetchJobs(filters = {}) {
            if (fetchController) {
                fetchController.abort();
            }

            fetchController = new AbortController();
            jobListContainer.innerHTML = '<p class="no-jobs-found">Loading jobs...</p>';

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/filter_jobs`, {
                    method: 'POST',
                    signal: fetchController.signal,
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        keyword: filters.keyword || null,
                        city_state: filters.city_state || null,
                        postal_code: filters.postal_code || null,
                        distance_miles: filters.distance_miles || null,
                        employment_types: [],
                        experience_level: null,
                        workplace_types: []
                    })
                });

                if (!response.ok) {
                    jobListContainer.innerHTML = `<p class="no-jobs-found">Error: ${escapeHtml(response.statusText)}</p>`;
                    return;
                }

                const data = await response.json();
                currentJobs = data.map(job => ({
                    id: job.id,
                    title: job.job_title,
                    company: job.company,
                    location: job.location,
                    types: extractJobType(job.job_title, job.description),
                    level: job.level,
                    url: job.url,
                    description: job.description,
                    posted_date: job.posted_date,
                    is_featured: job.is_featured
                }));
            } catch (err) {
                if (err.name === 'AbortError') return;
                document.getElementById('jbw-job-list').innerHTML = `<p class="no-jobs-found">Connection error: ${escapeHtml(err.message)}</p>`;
            }
        }

        function extractJobType(title, description) {
            const normalize = str => String(str || '').toLowerCase().replace(/[-\s]/g, '');
            const titleNorm = normalize(title);
            const descNorm = normalize(description);
            const types = ['contract', 'full-time', 'part-time', 'per-diem', 'prn'];
            const matches = types.filter(type =>
                titleNorm.includes(normalize(type)) || descNorm.includes(normalize(type))
            ).map(type => {
                if (type.toLowerCase() === 'prn') return 'PRN';
                // Only first letter uppercase, rest lowercase for each word
                return type.split('-').map((w, i) => i === 0 ? w.charAt(0).toUpperCase() + w.slice(1).toLowerCase() : w.toLowerCase()).join('-');
            });
            return matches.length > 0 ? matches : ['Full-time'];
        }

        // --- 2. US STATES DATA & DROPDOWN LOGIC ---
        const US_STATES = [['', 'Select...'],['AL', 'Alabama'],['AK', 'Alaska'],['AZ', 'Arizona'],['AR', 'Arkansas'],['CA', 'California'],['CO', 'Colorado'],['CT', 'Connecticut'],['DE', 'Delaware'],['DC', 'District of Columbia'],['FL', 'Florida'],['GA', 'Georgia'],['HI', 'Hawaii'],['ID', 'Idaho'],['IL', 'Illinois'],['IN', 'Indiana'],['IA', 'Iowa'],['KS', 'Kansas'],['KY', 'Kentucky'],['LA', 'Louisiana'],['ME', 'Maine'],['MD', 'Maryland'],['MA', 'Massachusetts'],['MI', 'Michigan'],['MN', 'Minnesota'],['MS', 'Mississippi'],['MO', 'Missouri'],['MT', 'Montana'],['NE', 'Nebraska'],['NV', 'Nevada'],['NH', 'New Hampshire'],['NJ', 'New Jersey'],['NM', 'New Mexico'],['NY', 'New York'],['NC', 'North Carolina'],['ND', 'North Dakota'],['OH', 'Ohio'],['OK', 'Oklahoma'],['OR', 'Oregon'],['PA', 'Pennsylvania'],['RI', 'Rhode Island'],['SC', 'South Carolina'],['SD', 'South Dakota'],['TN', 'Tennessee'],['TX', 'Texas'],['UT', 'Utah'],['VT', 'Vermont'],['VA', 'Virginia'],['WA', 'Washington'],['WV', 'West Virginia'],['WI', 'Wisconsin'],['WY', 'Wyoming']];

        function populateStateDropdown() {
            if (!stateSelect) return;
            stateSelect.innerHTML = '';
            US_STATES.forEach(([code, name]) => {
                const opt = document.createElement('option');
                opt.value = code;
                opt.textContent = name;
                stateSelect.appendChild(opt);
            });
        }

        // --- 3. CENTRALIZED DOM REFERENCES (Refactor #2) ---
        const idSuffixes = [
            'city-input', 'clear-filters-link', 'job-list', 'level-filter',
            'miles-input', 'postal-input', 'search-input', 'state-select',
            'apply-text-filters', 'type-filter', 'workplace-filter'
        ];

        const els = idSuffixes.reduce((acc, suffix) => {
            const camelKey = suffix.replace(/-([a-z])/g, g => g[1].toUpperCase())
                                .replace('Link', 'Btn');
            acc[camelKey] = document.getElementById(`jbw-${suffix}`);
            return acc;
        }, {});

        const {
            cityInput, clearFiltersBtn, jobList: jobListContainer, levelFilter: levelFilterContainer,
            milesInput, postalInput, searchInput, stateSelect,
            applyTextFilters: textSearchBtn, typeFilter: typeFilterContainer,
            workplaceFilter: workplaceFilterContainer
        } = els;

        // Now these calls will work because stateSelect and the function are both defined
        populateStateDropdown();

        stateSelect.addEventListener('change', () => {
            stateSelect.classList.toggle('placeholder', stateSelect.value === '');
        });

        // --- 3. LOGO & UTILITIES ---
        const LOGO_DEV_PUBLIC_KEY = 'pk_placeholder';
        const getInitials = (name) => {
            if (!name) return '?';
            const parts = name.trim().split(/\s+/);
            return parts.length === 1 ? parts[0].substring(0, 2).toUpperCase() : (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        };

        const getCompanyColor = (() => {
            let colorList = null;
            let previousIdx = null;
            return (name) => {
                if (!colorList) {
                    colorList = [
                        getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim() || '#007daf',
                        getComputedStyle(document.documentElement).getPropertyValue('--secondary-color').trim() || '#e67300',
                        getComputedStyle(document.documentElement).getPropertyValue('--tertiary-color').trim() || '#10a597',
                        getComputedStyle(document.documentElement).getPropertyValue('--accent-primary').trim() || '#fdb813',
                        getComputedStyle(document.documentElement).getPropertyValue('--accent-secondary').trim() || '#bd3f67',
                    ];
                }
                let idx;
                do {
                    idx = Math.floor(Math.random() * colorList.length);
                } while (colorList.length > 1 && idx === previousIdx);
                previousIdx = idx;
                return colorList[idx];
            };
        })();

        const getLogoUrl = (companyName) => {
            if (!companyName) return null;
            const domain = companyName.toLowerCase().replace(/[^a-z0-9]/g, '') + '.com';
            return `https://img.logo.dev/${domain}?token=${LOGO_DEV_PUBLIC_KEY}&size=100`;
        };

        // --- 4. RENDERING LOGIC ---
        const renderJobs = (jobsToRender) => {
            jobListContainer.innerHTML = '';
            if (jobsToRender.length === 0) {
                jobListContainer.innerHTML = '<p class="no-jobs-found">No jobs found matching your criteria.</p>';
                return;
            }

            const fragment = document.createDocumentFragment();
            const sortedJobs = jobsToRender.slice().sort((a, b) => {
                // Sort jobs: featured first
                if (a.is_featured === b.is_featured) return 0;
                return a.is_featured ? -1 : 1;
            });
            const get_featured_title = title => title ? `‚ú®‚ú® ${title} ‚ú®‚ú®` : '‚ú®‚ú® Featured Job ‚ú®‚ú®';

            sortedJobs.forEach(job => {
                const jobCard = document.createElement('a');
                jobCard.classList.add('job-card');
                if (job.is_featured) {
                    jobCard.classList.add('job-card-featured');

                }
                jobCard.href = job.url; jobCard.target = "_blank";
                const companyName = job.company || 'Unknown', logoUrl = getLogoUrl(companyName), initials = getInitials(companyName), bgColor = getCompanyColor(companyName);

                jobCard.innerHTML = `
                    <div class="job-card-header">
                        <div class="logo-container">
                            <div class="logo-fallback" style="background-color: ${bgColor};">${initials}</div>
                            <img src="${logoUrl}" alt="${escapeHtml(companyName)} logo" onerror="this.style.display='none'">
                        </div>
                        <div>
                            <h2 class="job-card-title"></h2>
                            <p class="job-card-company"></p>
                        </div>
                    </div>
                    <div class="job-card-details">
                        <span>üìç <span class="job-card-location"></span></span>
                        <span class="job-card-type"></span>
                        <span class="job-card-level"></span>
                    </div>
                `;

                jobCard.querySelector('.job-card-company').textContent = companyName;
                jobCard.querySelector('.job-card-level').textContent = formatLevel(job.level || '');
                jobCard.querySelector('.job-card-location').textContent = job.location || '';
                jobCard.querySelector('.job-card-title').textContent = job.is_featured ? get_featured_title(job.title || '') : job.title || '';
                jobCard.querySelector('.job-card-type').textContent = (job.types && job.types.length > 0) ? job.types.join(', ') : '';

                fragment.appendChild(jobCard);
            });
            jobListContainer.appendChild(fragment);
        };

        // --- 5. FILTERING LOGIC ---
        // Helper: Extract work settings from job title (case-insensitive, returns array)
        function extractWorkSettings(title) {
            // Use location field as received from DB, unaltered
            // This function now expects the location as its argument
            const found = [];
            const locationStr = String(title || '');
            const explicitSettings = ['Remote', 'Hybrid', 'Field'];
            let hasExplicit = false;
            explicitSettings.forEach(setting => {
                if (locationStr.includes(setting)) {
                    found.push(setting);
                    hasExplicit = true;
                }
            });
            if (locationStr.includes('On-site') || !hasExplicit) {
                found.push('On-site');
            }
            return found;
        }

        // Helper: Normalize employment type from job title (matches backend logic)
        function extractEmploymentType(title) {
            const types = ['Contract', 'Full-time', 'Part-time', 'Per-diem', 'PRN'];
            const titleNorm = String(title || '').toLowerCase();
            // Try to find description in the job object if available
            let descNorm = '';
            if (typeof this !== 'undefined' && this.description) {
                descNorm = String(this.description).toLowerCase();
            }
            for (const type of types) {
                if (titleNorm.includes(type.toLowerCase()) || descNorm.includes(type.toLowerCase())) return type;
            }
            return 'Full-time';
        }

        // --- FILTERING LOGIC REFACTOR ---
        // Only top filters (above Search Jobs) trigger DB fetch. Bottom filters filter in-memory jobs.

        // Applies in-memory filters (bottom filters) to currentJobs and renders
        function applyInMemoryFilters() {
            let filteredJobs = currentJobs.slice();

            // Experience Level (single select)
            const selectedLevel = levelFilterContainer.querySelector('input[name="experience_level"]:checked');
            if (selectedLevel) {
                filteredJobs = filteredJobs.filter(job => {
                    return (job.level || '').toLowerCase() === selectedLevel.value.toLowerCase();
                });
            }

            // Employment Type (multi, AND logic)
            const selectedTypes = getCheckedValues(typeFilterContainer);
            if (selectedTypes.length > 0) {
                filteredJobs = filteredJobs.filter(job => {
                    // job.types is always an array
                    return job.types.some(type => selectedTypes.includes(type));
                });
            }

            // Work Setting (multi, OR logic)
            const selectedSettings = getCheckedValues(workplaceFilterContainer);
            if (selectedSettings.length > 0) {
                filteredJobs = filteredJobs.filter(job => {
                    const jobSettings = extractWorkSettings(job.location);
                    // OR logic: at least one selected setting matches jobSettings
                    return selectedSettings.some(setting => jobSettings.includes(setting));
                });
            }

            renderJobs(filteredJobs);
        }

        // Main filter function: only top filters trigger DB fetch
        const applyFilters = async () => {
            const city = cityInput.value.trim();
            const state = stateSelect.value;
            const postal = postalInput.value.trim();
            const distance = milesInput.value ? parseInt(milesInput.value, 10) : null;
            const errorEl = document.getElementById('jbw-filter-error');

            errorEl.classList.remove('visible');
            cityInput.classList.remove('jbw-input-error');
            stateSelect.classList.remove('jbw-input-error');
            postalInput.classList.remove('jbw-input-error');

            if ((city && !state) && !postal) {
                errorEl.textContent = 'Please select a state for the city provided.';
                errorEl.classList.add('visible');
                stateSelect.classList.add('jbw-input-error');
                return;
            }
            if ((state && !city) && !postal) {
                errorEl.textContent = 'Please enter a city for the state selected.';
                errorEl.classList.add('visible');
                cityInput.classList.add('jbw-input-error');
                return;
            }
            if ((city || state || postal) && !distance) {
                errorEl.textContent = 'Please provide a distance for location search.';
                errorEl.classList.add('visible');
                return;
            }

            let cityState = (city && state) ? `${city}, ${state}` : null;
            let postalCode = (postal && postal.length === 5) ? postal : null;
            const filters = {
                keyword: searchInput.value.trim() || null,
                city_state: cityState,
                postal_code: postalCode,
                distance_miles: (cityState || postalCode) ? distance : null,
                employment_types: [],
                experience_level: null,
                workplace_types: []
            };

            await fetchJobs(filters);
            applyInMemoryFilters(); // always apply in-memory filters after DB fetch
        };

        // --- 6. DRY MULTI-SELECT INITIALIZATION ---
        const activeDropdowns = [];

        function initMultiSelect(prefix, container) {
            const trigger = document.getElementById(`${prefix}-trigger`);
            const menu = document.getElementById(`${prefix}-menu`);
            const wrapper = document.getElementById(`${prefix}-wrapper`);
            const tagsContainer = document.getElementById(`${prefix}-tags-container`);
            const checkboxes = container.querySelectorAll('input[type="checkbox"]');

            const renderTags = () => {
                tagsContainer.innerHTML = '';
                let count = 0;
                checkboxes.forEach(cb => {
                    if (cb.checked) {
                        count++;
                        const tag = document.createElement('div');
                        tag.className = 'jbw-tag';
                        tag.innerHTML = `${cb.value}<span class="jbw-tag-remove" data-value="${cb.value}">√ó</span>`;
                        tagsContainer.appendChild(tag);
                    }
                });
                trigger.classList.toggle('placeholder', count === 0);
            };

            trigger.addEventListener('click', (e) => {
                e.stopPropagation();

                const filterPanel = document.getElementById('filter-panel');

                activeDropdowns.forEach(d => {
                    if (d.wrapper !== wrapper) {
                        d.menu.classList.remove('active');
                        d.wrapper.classList.remove('is-active', 'open-up');
                    }
                });

                const triggerRect = trigger.getBoundingClientRect();
                const panelRect = filterPanel.getBoundingClientRect();
                const menuHeight = 220;
                const spaceBelowInPanel = panelRect.bottom - triggerRect.bottom;
                const spaceBelowWindow = window.innerHeight - triggerRect.bottom;

                if (spaceBelowInPanel < menuHeight || spaceBelowWindow < menuHeight) {
                    wrapper.classList.add('open-up');
                } else {
                    wrapper.classList.remove('open-up');
                }

                const isActive = menu.classList.toggle('active');
                wrapper.classList.toggle('is-active', isActive);

                if (isActive && !wrapper.classList.contains('open-up')) {
                    setTimeout(() => {
                        menu.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 50);
                }
            });

            tagsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('jbw-tag-remove')) {
                    const val = e.target.getAttribute('data-value');
                    const cb = Array.from(checkboxes).find(c => c.value === val);
                    if (cb) { cb.checked = false; renderTags(); applyInMemoryFilters(); }
                }
            });

            checkboxes.forEach(cb => cb.addEventListener('change', () => { renderTags(); applyInMemoryFilters(); }));
            // Store reference for the clear button
            activeDropdowns.push({ wrapper, menu, renderTags });
            renderTags();
        }

        // Initialize both dropdowns
        initMultiSelect('wp', workplaceFilterContainer);
        initMultiSelect('jt', typeFilterContainer);

        // --- 7. EVENT LISTENERS ---
        textSearchBtn.addEventListener('click', applyFilters);
        [searchInput, cityInput, postalInput, milesInput].forEach(el => {
            el.addEventListener('keydown', (e) => { if (e.key === 'Enter') applyFilters(); });
        });

        // Real-time in-memory filtering for Experience Level (radio buttons)
        levelFilterContainer.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', applyInMemoryFilters);
        });

        document.addEventListener('click', (e) => {
            activeDropdowns.forEach(d => {
                if (!d.wrapper.contains(e.target)) {
                    d.menu.classList.remove('active');
                    d.wrapper.classList.remove('is-active'); // ensures z-index reset.
                }
            });
        });

        clearFiltersBtn.addEventListener('click', async (e) => {
            e.preventDefault();

            searchInput.value = '';
            cityInput.value = '';
            stateSelect.value = '';
            stateSelect.classList.add('placeholder');
            postalInput.value = '';
            milesInput.value = '30';

            const errorEl = document.getElementById('jbw-filter-error');
            if (errorEl) errorEl.classList.remove('visible');
            [cityInput, stateSelect, postalInput].forEach(el => el.classList.remove('jbw-input-error'));

            ROOT.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(el => el.checked = false);

            activeDropdowns.forEach(d => d.renderTags());

            await fetchJobs({});
            applyInMemoryFilters();
        });

        (async () => {
            await fetchJobs({});
            applyInMemoryFilters();
        })();
    })();
</script>
<!-- END Circle Widget Body -->

</body>
</html>